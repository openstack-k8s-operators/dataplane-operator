# Deploying an OpenStackDataPlaneNodeSet with Internal TLS Enabled

When an OpenStackDataPlaneNodeSet is deployed with TLS Enabled, communications
between dataplane services and with control plane services can be encrypted using
TLS connections.
`
Functionality has been added to the dataplane-operator to generate the needed
certificates for all compute nodes in the nodeset.  The details on how to enable
this functionality and how dataplane services (including custom services) can take
advantage of this functionality is provided here.

In addtion, an attribute has been added to the OpenStackDataplaneService spec to
allow a CACert TLS bundle to be provided.

## Prerequisites

Certificates for dataplane services are generated by certmanager issuers, which are
referenced in the OpenStackDataplaneService attributes below.  These issuers must be
created beforehand.

In addition, OpenStackDataplaneService contains an attribute that allows the deployer
to specify a secret containing a TLS CA bundle.  This secret should also be created
beforehand.

## Basic deloyment steps

1. Create the issuers and cacert bundle secrets as described in the pre-requisites above.
   These were likely created as part of the control plane deployment. 
   (TODO - link to issuer/cacert docs when available)

2. Enable TLS on the OpenStackDataPlaneNodeSet and create the nodeset.  Ensure that the
   install-certs or similar service (described below) is in the list of services before
   any services that require certs.

3. Deploy the OpenStackDataPlane.  Certs should be created and copied to the compute nodes
   in the nodeset.
 
## Enabling TLS on an OpenStackDataPlaneNodeSet

The OpenstackDataPlaneNodeSet has an attribute tlsEnabled, which defaults to false.
The certficate generation code will be executed only if this attribute is set to true.

## OpenStackDataplaneService attributes

Certificate generation is controlled by several attributes in the OpenstackDataplaneService
specification.  An example is provided below.

apiVersion: dataplane.openstack.org/v1beta1
kind: OpenStackDataPlaneService
metadata:
  name: libvirt
spec:
  label: libvirt
  playbook: osp.edpm.libvirt
  tlsCert:
    contents:
      - dnsnames
      - ips
    networks:
      - CtlPlane
    issuer: osp-rootca-issuer-internal
  caCerts: combined-ca-bundle

A more minimal configuration is provided below:

apiVersion: dataplane.openstack.org/v1beta1
kind: OpenStackDataPlaneService
metadata:
  name: service1
spec:
  label: service1
  playbook: osp.edpm.service1
  tlsCert:
    contents:
      - dnsnames
  caCerts: combined-ca-bundle

### caCerts
This optional attribute is a string pointing to the secret containing the TLS CA certificate
bundle to be mounted for the dataplane service.  This secret is expected to be created in
the same namespace (default: openstack) beforehand.

### tlsCert
Not all dataplane services will require TLS certificates.  For example, dataplane services
that install the OS or download caches do not need TLS certificates.

If a tlsCert is defined (and tlsEnabled is set on the nodeset), certs will be generated
as prescibed by the following attributes:

#### contents
This attribute describes what information is included in the subject alternative names (SAN)
in the certificate.  At this time, only two values are possible ("dnsnames" and "ips").
In the libvirt example, both attributes are added.  This attribute is required.

#### networks
This attribute describes which networks will be added to the SAN.  For instance, in the libvirt
example configuration, the DNSName and IPAdress for the node on the Ctlplane will be added to the SAN.
If networks is not defined, the relevant contents for all networks will be added to the SAN.
So, in the configuration for service1 above, dns names for all networks on the node are added
to the SAN.

#### issuer
This attribute corresponds to the certmanager issuer that will be used to issue the certificate.
If the issuers attribute is not set (as in the configuarion above for service1), certificates
will be issued using the default root CA for internal TLS as defined in lib-common.
(currently set to "osp-rootca-issuer-internal").

### addCertMounts
This attribute specifies whether or not to mount the certificates and keys generated for all
dataplane services (for all nodes in the nodeset) in the ansible EE pod for the service.
This attribute defaults to false.

The current design has a special dataplane service "install-certs" that is expected to run before
any services that need certificates, and which has this attribute set to true.  The purpose of this
dataplane service is to copy the certs to the correct place on the compute nodes.  This dataplane
service is described in more detail below.

## The gritty details

### How the certificates are generated

When tlsEnabled is set to True on the nodeset, and tlsCert is defined for the dataplane
service, certificates will be requested from the certmanager issuer designated in the issuer attribute
(or a default) as described above.

The contents of the certificate (subject name, subject alternative names, etc.) is defined using the
contents and issuer attributes as described above.

The certficates are generated when an OpenstackDataplaneDeployment is created, but before any ansible EE
pods are created.

When the certificates are created, certmanager stores the certificates in secrets which are named
"cert-\<service_name\>-\<node_name\>".  Each secret contains the certificate, key and cacert.

The certificates for all the nodes in the nodeset for a given service are all collected in a secret named
"\<nodeset\>-\<service_name\>-certs".  This secret is the one that is mounted in the ansibleEE when
when addCertMounts is enabled.  The code here is also slated to be refactored soon to ensure that we are
able to accomodate large deployments.

### How the certificates are transferred to the compute nodes

A dataplane service ("install-certs") has been added to added to copy over the certificates to the
compute nodes.  As noted above, this service has the addCertMounts attribute set to True.  It is expected
that this service will be executed before any other services that require TLS certs.

The service:
- Mounts the \<nodeset\>-\<service_name\>-certs secrets for all services that have tlsCertsEnabled set to true.
- Calls the osp.edpm.install_certs role which - for each node - copies all the certificates and keys for that
  node to /var/lib/openstack/certs/\<service_name\>.  The ca cert bundles are copied to
  /var/lib/openstack/cacerts/\<service_name\>

Code should then be added to each service's ansible role to use the certs as needed.  For example, in
libvirt's role, we move the certs and keys to standard locations on the compute host.  Other roles may
mount the certs and keys into their containers using kolla or otherwise.  The certs and keys for all the
services are available as needed for all services.

### How to enable cert generation for your dataplane service

Based on the above description, the steps are pretty straightforward.

1. Add a tlsCert attribute to your dataplane service.  Set the contents, networks and issuer according
   to your needs.  The service1 configuration is a minimal specification and will provide a cert
   with dnsNames for all the interfaces of the compute node in the SAN, issued by the internal TLS CA.
   This is probably sufficient for most use cases.
2. Add a specification for a CACertBundle.  This attribute can be added to mount a CACert bundle even
   if no cert generation is needed.
3. The "install-certs: service should run before your service.  It will copy the certs and cacerts
   to a standard location.  See the section above.
4. Modify your role to do something with the generated certs.
